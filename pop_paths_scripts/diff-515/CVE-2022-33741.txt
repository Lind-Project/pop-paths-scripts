<!DOCTYPE html>
<html lang='en'>
<head>
<title>kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit '/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='http://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='kernel/git/torvalds/linux.git' href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='ed3cfc690675d852c3416aedb271e0e7d179bf49'/><select name='h' onchange='this.form.submit();'>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ed3cfc690675d852c3416aedb271e0e7d179bf49'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ed3cfc690675d852c3416aedb271e0e7d179bf49'>tree</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ed3cfc690675d852c3416aedb271e0e7d179bf49'>commit</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ed3cfc690675d852c3416aedb271e0e7d179bf49'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='ed3cfc690675d852c3416aedb271e0e7d179bf49'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='ed3cfc690675d852c3416aedb271e0e7d179bf49'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ed3cfc690675d852c3416aedb271e0e7d179bf49'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/net/xen-netfront.c?id=ed3cfc690675d852c3416aedb271e0e7d179bf49'>drivers/net/xen-netfront.c</a></td><td class='right'>49</td><td class='graph'><table summary='file diffstat' width='49%'><tr><td class='add' style='width: 95.9%;'/><td class='rem' style='width: 4.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 47 insertions, 2 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/xen-netfront.c b/drivers/net/xen-netfront.c<br/>index cae8537115a89..409ee9d97af48 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/net/xen-netfront.c?id=5dd0993c36832d33820238fc8dc741ba801b7961'>drivers/net/xen-netfront.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/net/xen-netfront.c?id=ed3cfc690675d852c3416aedb271e0e7d179bf49'>drivers/net/xen-netfront.c</a></div><div class='hunk'>@@ -66,6 +66,10 @@ module_param_named(max_queues, xennet_max_queues, uint, 0644);</div><div class='ctx'> MODULE_PARM_DESC(max_queues,</div><div class='ctx'> 		 "Maximum number of queues per virtual interface");</div><div class='ctx'> </div><div class='add'>+static bool __read_mostly xennet_trusted = true;</div><div class='add'>+module_param_named(trusted, xennet_trusted, bool, 0644);</div><div class='add'>+MODULE_PARM_DESC(trusted, "Is the backend trusted");</div><div class='add'>+</div><div class='ctx'> #define XENNET_TIMEOUT  (5 * HZ)</div><div class='ctx'> </div><div class='ctx'> static const struct ethtool_ops xennet_ethtool_ops;</div><div class='hunk'>@@ -175,6 +179,9 @@ struct netfront_info {</div><div class='ctx'> 	/* Is device behaving sane? */</div><div class='ctx'> 	bool broken;</div><div class='ctx'> </div><div class='add'>+	/* Should skbs be bounced into a zeroed buffer? */</div><div class='add'>+	bool bounce;</div><div class='add'>+</div><div class='ctx'> 	atomic_t rx_gso_checksum_fixup;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='hunk'>@@ -668,6 +675,33 @@ static int xennet_xdp_xmit(struct net_device *dev, int n,</div><div class='ctx'> 	return nxmit;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+struct sk_buff *bounce_skb(const struct sk_buff *skb)</div><div class='add'>+{</div><div class='add'>+	unsigned int headerlen = skb_headroom(skb);</div><div class='add'>+	/* Align size to allocate full pages and avoid contiguous data leaks */</div><div class='add'>+	unsigned int size = ALIGN(skb_end_offset(skb) + skb-&gt;data_len,</div><div class='add'>+				  XEN_PAGE_SIZE);</div><div class='add'>+	struct sk_buff *n = alloc_skb(size, GFP_ATOMIC | __GFP_ZERO);</div><div class='add'>+</div><div class='add'>+	if (!n)</div><div class='add'>+		return NULL;</div><div class='add'>+</div><div class='add'>+	if (!IS_ALIGNED((uintptr_t)n-&gt;head, XEN_PAGE_SIZE)) {</div><div class='add'>+		WARN_ONCE(1, "misaligned skb allocated\n");</div><div class='add'>+		kfree_skb(n);</div><div class='add'>+		return NULL;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	/* Set the data pointer */</div><div class='add'>+	skb_reserve(n, headerlen);</div><div class='add'>+	/* Set the tail pointer and length */</div><div class='add'>+	skb_put(n, skb-&gt;len);</div><div class='add'>+</div><div class='add'>+	BUG_ON(skb_copy_bits(skb, -headerlen, n-&gt;head, headerlen + skb-&gt;len));</div><div class='add'>+</div><div class='add'>+	skb_copy_header(n, skb);</div><div class='add'>+	return n;</div><div class='add'>+}</div><div class='ctx'> </div><div class='ctx'> #define MAX_XEN_SKB_FRAGS (65536 / XEN_PAGE_SIZE + 1)</div><div class='ctx'> </div><div class='hunk'>@@ -721,9 +755,13 @@ static netdev_tx_t xennet_start_xmit(struct sk_buff *skb, struct net_device *dev</div><div class='ctx'> </div><div class='ctx'> 	/* The first req should be at least ETH_HLEN size or the packet will be</div><div class='ctx'> 	 * dropped by netback.</div><div class='add'>+	 *</div><div class='add'>+	 * If the backend is not trusted bounce all data to zeroed pages to</div><div class='add'>+	 * avoid exposing contiguous data on the granted page not belonging to</div><div class='add'>+	 * the skb.</div><div class='ctx'> 	 */</div><div class='del'>-	if (unlikely(PAGE_SIZE - offset &lt; ETH_HLEN)) {</div><div class='del'>-		nskb = skb_copy(skb, GFP_ATOMIC);</div><div class='add'>+	if (np-&gt;bounce || unlikely(PAGE_SIZE - offset &lt; ETH_HLEN)) {</div><div class='add'>+		nskb = bounce_skb(skb);</div><div class='ctx'> 		if (!nskb)</div><div class='ctx'> 			goto drop;</div><div class='ctx'> 		dev_consume_skb_any(skb);</div><div class='hunk'>@@ -2247,6 +2285,10 @@ static int talk_to_netback(struct xenbus_device *dev,</div><div class='ctx'> </div><div class='ctx'> 	info-&gt;netdev-&gt;irq = 0;</div><div class='ctx'> </div><div class='add'>+	/* Check if backend is trusted. */</div><div class='add'>+	info-&gt;bounce = !xennet_trusted ||</div><div class='add'>+		       !xenbus_read_unsigned(dev-&gt;nodename, "trusted", 1);</div><div class='add'>+</div><div class='ctx'> 	/* Check if backend supports multiple queues */</div><div class='ctx'> 	max_queues = xenbus_read_unsigned(info-&gt;xbdev-&gt;otherend,</div><div class='ctx'> 					  "multi-queue-max-queues", 1);</div><div class='hunk'>@@ -2413,6 +2455,9 @@ static int xennet_connect(struct net_device *dev)</div><div class='ctx'> 		return err;</div><div class='ctx'> 	if (np-&gt;netback_has_xdp_headroom)</div><div class='ctx'> 		pr_info("backend supports XDP headroom\n");</div><div class='add'>+	if (np-&gt;bounce)</div><div class='add'>+		dev_info(&amp;np-&gt;xbdev-&gt;dev,</div><div class='add'>+			 "bouncing transmitted data to zeroed pages\n");</div><div class='ctx'> </div><div class='ctx'> 	/* talk_to_netback() sets the correct number of queues */</div><div class='ctx'> 	num_queues = dev-&gt;real_num_tx_queues;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit </a> (<a href='https://git-scm.com/'>git 2.34.1</a>) at 2023-02-02 23:01:03 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
