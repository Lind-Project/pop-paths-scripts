<!DOCTYPE html>
<html lang='en'>
<head>
<title>kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit '/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='http://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='kernel/git/torvalds/linux.git' href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='6d0a9127279a4533815202e30ad1b3a39f560ba3'/><select name='h' onchange='this.form.submit();'>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=6d0a9127279a4533815202e30ad1b3a39f560ba3'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=6d0a9127279a4533815202e30ad1b3a39f560ba3'>tree</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6d0a9127279a4533815202e30ad1b3a39f560ba3'>commit</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=6d0a9127279a4533815202e30ad1b3a39f560ba3'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='6d0a9127279a4533815202e30ad1b3a39f560ba3'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='6d0a9127279a4533815202e30ad1b3a39f560ba3'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=6d0a9127279a4533815202e30ad1b3a39f560ba3'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/block/xen-blkfront.c?id=6d0a9127279a4533815202e30ad1b3a39f560ba3'>drivers/block/xen-blkfront.c</a></td><td class='right'>49</td><td class='graph'><table summary='file diffstat' width='49%'><tr><td class='add' style='width: 69.4%;'/><td class='rem' style='width: 30.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 34 insertions, 15 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/block/xen-blkfront.c b/drivers/block/xen-blkfront.c<br/>index 317b0b0994051..f6f679702b832 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/block/xen-blkfront.c?id=ed3cfc690675d852c3416aedb271e0e7d179bf49'>drivers/block/xen-blkfront.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/block/xen-blkfront.c?id=6d0a9127279a4533815202e30ad1b3a39f560ba3'>drivers/block/xen-blkfront.c</a></div><div class='hunk'>@@ -152,6 +152,10 @@ static unsigned int xen_blkif_max_ring_order;</div><div class='ctx'> module_param_named(max_ring_page_order, xen_blkif_max_ring_order, int, 0444);</div><div class='ctx'> MODULE_PARM_DESC(max_ring_page_order, "Maximum order of pages to be used for the shared ring");</div><div class='ctx'> </div><div class='add'>+static bool __read_mostly xen_blkif_trusted = true;</div><div class='add'>+module_param_named(trusted, xen_blkif_trusted, bool, 0644);</div><div class='add'>+MODULE_PARM_DESC(trusted, "Is the backend trusted");</div><div class='add'>+</div><div class='ctx'> #define BLK_RING_SIZE(info)	\</div><div class='ctx'> 	__CONST_RING_SIZE(blkif, XEN_PAGE_SIZE * (info)-&gt;nr_ring_pages)</div><div class='ctx'> </div><div class='hunk'>@@ -209,6 +213,7 @@ struct blkfront_info</div><div class='ctx'> 	unsigned int feature_discard:1;</div><div class='ctx'> 	unsigned int feature_secdiscard:1;</div><div class='ctx'> 	unsigned int feature_persistent:1;</div><div class='add'>+	unsigned int bounce:1;</div><div class='ctx'> 	unsigned int discard_granularity;</div><div class='ctx'> 	unsigned int discard_alignment;</div><div class='ctx'> 	/* Number of 4KB segments handled */</div><div class='hunk'>@@ -311,7 +316,7 @@ static int fill_grant_buffer(struct blkfront_ring_info *rinfo, int num)</div><div class='ctx'> 		if (!gnt_list_entry)</div><div class='ctx'> 			goto out_of_memory;</div><div class='ctx'> </div><div class='del'>-		if (info-&gt;feature_persistent) {</div><div class='add'>+		if (info-&gt;bounce) {</div><div class='ctx'> 			granted_page = alloc_page(GFP_NOIO | __GFP_ZERO);</div><div class='ctx'> 			if (!granted_page) {</div><div class='ctx'> 				kfree(gnt_list_entry);</div><div class='hunk'>@@ -331,7 +336,7 @@ out_of_memory:</div><div class='ctx'> 	list_for_each_entry_safe(gnt_list_entry, n,</div><div class='ctx'> 	                         &amp;rinfo-&gt;grants, node) {</div><div class='ctx'> 		list_del(&amp;gnt_list_entry-&gt;node);</div><div class='del'>-		if (info-&gt;feature_persistent)</div><div class='add'>+		if (info-&gt;bounce)</div><div class='ctx'> 			__free_page(gnt_list_entry-&gt;page);</div><div class='ctx'> 		kfree(gnt_list_entry);</div><div class='ctx'> 		i--;</div><div class='hunk'>@@ -377,7 +382,7 @@ static struct grant *get_grant(grant_ref_t *gref_head,</div><div class='ctx'> 	/* Assign a gref to this page */</div><div class='ctx'> 	gnt_list_entry-&gt;gref = gnttab_claim_grant_reference(gref_head);</div><div class='ctx'> 	BUG_ON(gnt_list_entry-&gt;gref == -ENOSPC);</div><div class='del'>-	if (info-&gt;feature_persistent)</div><div class='add'>+	if (info-&gt;bounce)</div><div class='ctx'> 		grant_foreign_access(gnt_list_entry, info);</div><div class='ctx'> 	else {</div><div class='ctx'> 		/* Grant access to the GFN passed by the caller */</div><div class='hunk'>@@ -401,7 +406,7 @@ static struct grant *get_indirect_grant(grant_ref_t *gref_head,</div><div class='ctx'> 	/* Assign a gref to this page */</div><div class='ctx'> 	gnt_list_entry-&gt;gref = gnttab_claim_grant_reference(gref_head);</div><div class='ctx'> 	BUG_ON(gnt_list_entry-&gt;gref == -ENOSPC);</div><div class='del'>-	if (!info-&gt;feature_persistent) {</div><div class='add'>+	if (!info-&gt;bounce) {</div><div class='ctx'> 		struct page *indirect_page;</div><div class='ctx'> </div><div class='ctx'> 		/* Fetch a pre-allocated page to use for indirect grefs */</div><div class='hunk'>@@ -703,7 +708,7 @@ static int blkif_queue_rw_req(struct request *req, struct blkfront_ring_info *ri</div><div class='ctx'> 		.grant_idx = 0,</div><div class='ctx'> 		.segments = NULL,</div><div class='ctx'> 		.rinfo = rinfo,</div><div class='del'>-		.need_copy = rq_data_dir(req) &amp;&amp; info-&gt;feature_persistent,</div><div class='add'>+		.need_copy = rq_data_dir(req) &amp;&amp; info-&gt;bounce,</div><div class='ctx'> 	};</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='hunk'>@@ -981,11 +986,12 @@ static void xlvbd_flush(struct blkfront_info *info)</div><div class='ctx'> {</div><div class='ctx'> 	blk_queue_write_cache(info-&gt;rq, info-&gt;feature_flush ? true : false,</div><div class='ctx'> 			      info-&gt;feature_fua ? true : false);</div><div class='del'>-	pr_info("blkfront: %s: %s %s %s %s %s\n",</div><div class='add'>+	pr_info("blkfront: %s: %s %s %s %s %s %s %s\n",</div><div class='ctx'> 		info-&gt;gd-&gt;disk_name, flush_info(info),</div><div class='ctx'> 		"persistent grants:", info-&gt;feature_persistent ?</div><div class='ctx'> 		"enabled;" : "disabled;", "indirect descriptors:",</div><div class='del'>-		info-&gt;max_indirect_segments ? "enabled;" : "disabled;");</div><div class='add'>+		info-&gt;max_indirect_segments ? "enabled;" : "disabled;",</div><div class='add'>+		"bounce buffer:", info-&gt;bounce ? "enabled" : "disabled;");</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int xen_translate_vdev(int vdevice, int *minor, unsigned int *offset)</div><div class='hunk'>@@ -1212,7 +1218,7 @@ static void blkif_free_ring(struct blkfront_ring_info *rinfo)</div><div class='ctx'> 	if (!list_empty(&amp;rinfo-&gt;indirect_pages)) {</div><div class='ctx'> 		struct page *indirect_page, *n;</div><div class='ctx'> </div><div class='del'>-		BUG_ON(info-&gt;feature_persistent);</div><div class='add'>+		BUG_ON(info-&gt;bounce);</div><div class='ctx'> 		list_for_each_entry_safe(indirect_page, n, &amp;rinfo-&gt;indirect_pages, lru) {</div><div class='ctx'> 			list_del(&amp;indirect_page-&gt;lru);</div><div class='ctx'> 			__free_page(indirect_page);</div><div class='hunk'>@@ -1229,7 +1235,7 @@ static void blkif_free_ring(struct blkfront_ring_info *rinfo)</div><div class='ctx'> 							  0, 0UL);</div><div class='ctx'> 				rinfo-&gt;persistent_gnts_c--;</div><div class='ctx'> 			}</div><div class='del'>-			if (info-&gt;feature_persistent)</div><div class='add'>+			if (info-&gt;bounce)</div><div class='ctx'> 				__free_page(persistent_gnt-&gt;page);</div><div class='ctx'> 			kfree(persistent_gnt);</div><div class='ctx'> 		}</div><div class='hunk'>@@ -1250,7 +1256,7 @@ static void blkif_free_ring(struct blkfront_ring_info *rinfo)</div><div class='ctx'> 		for (j = 0; j &lt; segs; j++) {</div><div class='ctx'> 			persistent_gnt = rinfo-&gt;shadow[i].grants_used[j];</div><div class='ctx'> 			gnttab_end_foreign_access(persistent_gnt-&gt;gref, 0, 0UL);</div><div class='del'>-			if (info-&gt;feature_persistent)</div><div class='add'>+			if (info-&gt;bounce)</div><div class='ctx'> 				__free_page(persistent_gnt-&gt;page);</div><div class='ctx'> 			kfree(persistent_gnt);</div><div class='ctx'> 		}</div><div class='hunk'>@@ -1440,7 +1446,7 @@ static int blkif_completion(unsigned long *id,</div><div class='ctx'> 	data.s = s;</div><div class='ctx'> 	num_sg = s-&gt;num_sg;</div><div class='ctx'> </div><div class='del'>-	if (bret-&gt;operation == BLKIF_OP_READ &amp;&amp; info-&gt;feature_persistent) {</div><div class='add'>+	if (bret-&gt;operation == BLKIF_OP_READ &amp;&amp; info-&gt;bounce) {</div><div class='ctx'> 		for_each_sg(s-&gt;sg, sg, num_sg, i) {</div><div class='ctx'> 			BUG_ON(sg-&gt;offset + sg-&gt;length &gt; PAGE_SIZE);</div><div class='ctx'> </div><div class='hunk'>@@ -1499,7 +1505,7 @@ static int blkif_completion(unsigned long *id,</div><div class='ctx'> 				 * Add the used indirect page back to the list of</div><div class='ctx'> 				 * available pages for indirect grefs.</div><div class='ctx'> 				 */</div><div class='del'>-				if (!info-&gt;feature_persistent) {</div><div class='add'>+				if (!info-&gt;bounce) {</div><div class='ctx'> 					indirect_page = s-&gt;indirect_grants[i]-&gt;page;</div><div class='ctx'> 					list_add(&amp;indirect_page-&gt;lru, &amp;rinfo-&gt;indirect_pages);</div><div class='ctx'> 				}</div><div class='hunk'>@@ -1790,6 +1796,10 @@ static int talk_to_blkback(struct xenbus_device *dev,</div><div class='ctx'> 	if (!info)</div><div class='ctx'> 		return -ENODEV;</div><div class='ctx'> </div><div class='add'>+	/* Check if backend is trusted. */</div><div class='add'>+	info-&gt;bounce = !xen_blkif_trusted ||</div><div class='add'>+		       !xenbus_read_unsigned(dev-&gt;nodename, "trusted", 1);</div><div class='add'>+</div><div class='ctx'> 	max_page_order = xenbus_read_unsigned(info-&gt;xbdev-&gt;otherend,</div><div class='ctx'> 					      "max-ring-page-order", 0);</div><div class='ctx'> 	ring_page_order = min(xen_blkif_max_ring_order, max_page_order);</div><div class='hunk'>@@ -2199,10 +2209,10 @@ static int blkfront_setup_indirect(struct blkfront_ring_info *rinfo)</div><div class='ctx'> 	if (err)</div><div class='ctx'> 		goto out_of_memory;</div><div class='ctx'> </div><div class='del'>-	if (!info-&gt;feature_persistent &amp;&amp; info-&gt;max_indirect_segments) {</div><div class='add'>+	if (!info-&gt;bounce &amp;&amp; info-&gt;max_indirect_segments) {</div><div class='ctx'> 		/*</div><div class='del'>-		 * We are using indirect descriptors but not persistent</div><div class='del'>-		 * grants, we need to allocate a set of pages that can be</div><div class='add'>+		 * We are using indirect descriptors but don't have a bounce</div><div class='add'>+		 * buffer, we need to allocate a set of pages that can be</div><div class='ctx'> 		 * used for mapping indirect grefs</div><div class='ctx'> 		 */</div><div class='ctx'> 		int num = INDIRECT_GREFS(grants) * BLK_RING_SIZE(info);</div><div class='hunk'>@@ -2303,6 +2313,8 @@ static void blkfront_gather_backend_features(struct blkfront_info *info)</div><div class='ctx'> 		info-&gt;feature_persistent =</div><div class='ctx'> 			!!xenbus_read_unsigned(info-&gt;xbdev-&gt;otherend,</div><div class='ctx'> 					       "feature-persistent", 0);</div><div class='add'>+	if (info-&gt;feature_persistent)</div><div class='add'>+		info-&gt;bounce = true;</div><div class='ctx'> </div><div class='ctx'> 	indirect_segments = xenbus_read_unsigned(info-&gt;xbdev-&gt;otherend,</div><div class='ctx'> 					"feature-max-indirect-segments", 0);</div><div class='hunk'>@@ -2566,6 +2578,13 @@ static void blkfront_delay_work(struct work_struct *work)</div><div class='ctx'> 	struct blkfront_info *info;</div><div class='ctx'> 	bool need_schedule_work = false;</div><div class='ctx'> </div><div class='add'>+	/*</div><div class='add'>+	 * Note that when using bounce buffers but not persistent grants</div><div class='add'>+	 * there's no need to run blkfront_delay_work because grants are</div><div class='add'>+	 * revoked in blkif_completion or else an error is reported and the</div><div class='add'>+	 * connection is closed.</div><div class='add'>+	 */</div><div class='add'>+</div><div class='ctx'> 	mutex_lock(&amp;blkfront_mutex);</div><div class='ctx'> </div><div class='ctx'> 	list_for_each_entry(info, &amp;info_list, info_list) {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit </a> (<a href='https://git-scm.com/'>git 2.34.1</a>) at 2023-02-02 23:01:02 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
