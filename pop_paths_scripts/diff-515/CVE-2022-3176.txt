<!DOCTYPE html>
<html lang='en'>
<head>
<title>kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit '/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='http://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='kernel/git/torvalds/linux.git' href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='e9d7ca0c4640cbebe6840ee3bac66a25a9bacaf5'/><select name='h' onchange='this.form.submit();'>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=e9d7ca0c4640cbebe6840ee3bac66a25a9bacaf5'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e9d7ca0c4640cbebe6840ee3bac66a25a9bacaf5'>tree</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e9d7ca0c4640cbebe6840ee3bac66a25a9bacaf5'>commit</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e9d7ca0c4640cbebe6840ee3bac66a25a9bacaf5'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='e9d7ca0c4640cbebe6840ee3bac66a25a9bacaf5'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='e9d7ca0c4640cbebe6840ee3bac66a25a9bacaf5'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e9d7ca0c4640cbebe6840ee3bac66a25a9bacaf5'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/io_uring.c?id=e9d7ca0c4640cbebe6840ee3bac66a25a9bacaf5'>fs/io_uring.c</a></td><td class='right'>58</td><td class='graph'><table summary='file diffstat' width='58%'><tr><td class='add' style='width: 86.2%;'/><td class='rem' style='width: 13.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 50 insertions, 8 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/io_uring.c b/fs/io_uring.c<br/>index be04b0f0872ba..ed6abd74f3865 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/io_uring.c?id=182dc3aa5ae2f6e2ec6a95667845a819179a78e8'>fs/io_uring.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/io_uring.c?id=e9d7ca0c4640cbebe6840ee3bac66a25a9bacaf5'>fs/io_uring.c</a></div><div class='hunk'>@@ -5369,12 +5369,14 @@ static void io_init_poll_iocb(struct io_poll_iocb *poll, __poll_t events,</div><div class='ctx'> </div><div class='ctx'> static inline void io_poll_remove_entry(struct io_poll_iocb *poll)</div><div class='ctx'> {</div><div class='del'>-	struct wait_queue_head *head = poll-&gt;head;</div><div class='add'>+	struct wait_queue_head *head = smp_load_acquire(&amp;poll-&gt;head);</div><div class='ctx'> </div><div class='del'>-	spin_lock_irq(&amp;head-&gt;lock);</div><div class='del'>-	list_del_init(&amp;poll-&gt;wait.entry);</div><div class='del'>-	poll-&gt;head = NULL;</div><div class='del'>-	spin_unlock_irq(&amp;head-&gt;lock);</div><div class='add'>+	if (head) {</div><div class='add'>+		spin_lock_irq(&amp;head-&gt;lock);</div><div class='add'>+		list_del_init(&amp;poll-&gt;wait.entry);</div><div class='add'>+		poll-&gt;head = NULL;</div><div class='add'>+		spin_unlock_irq(&amp;head-&gt;lock);</div><div class='add'>+	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void io_poll_remove_entries(struct io_kiocb *req)</div><div class='hunk'>@@ -5382,10 +5384,26 @@ static void io_poll_remove_entries(struct io_kiocb *req)</div><div class='ctx'> 	struct io_poll_iocb *poll = io_poll_get_single(req);</div><div class='ctx'> 	struct io_poll_iocb *poll_double = io_poll_get_double(req);</div><div class='ctx'> </div><div class='del'>-	if (poll-&gt;head)</div><div class='del'>-		io_poll_remove_entry(poll);</div><div class='del'>-	if (poll_double &amp;&amp; poll_double-&gt;head)</div><div class='add'>+	/*</div><div class='add'>+	 * While we hold the waitqueue lock and the waitqueue is nonempty,</div><div class='add'>+	 * wake_up_pollfree() will wait for us.  However, taking the waitqueue</div><div class='add'>+	 * lock in the first place can race with the waitqueue being freed.</div><div class='add'>+	 *</div><div class='add'>+	 * We solve this as eventpoll does: by taking advantage of the fact that</div><div class='add'>+	 * all users of wake_up_pollfree() will RCU-delay the actual free.  If</div><div class='add'>+	 * we enter rcu_read_lock() and see that the pointer to the queue is</div><div class='add'>+	 * non-NULL, we can then lock it without the memory being freed out from</div><div class='add'>+	 * under us.</div><div class='add'>+	 *</div><div class='add'>+	 * Keep holding rcu_read_lock() as long as we hold the queue lock, in</div><div class='add'>+	 * case the caller deletes the entry from the queue, leaving it empty.</div><div class='add'>+	 * In that case, only RCU prevents the queue memory from being freed.</div><div class='add'>+	 */</div><div class='add'>+	rcu_read_lock();</div><div class='add'>+	io_poll_remove_entry(poll);</div><div class='add'>+	if (poll_double)</div><div class='ctx'> 		io_poll_remove_entry(poll_double);</div><div class='add'>+	rcu_read_unlock();</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='hunk'>@@ -5523,6 +5541,30 @@ static int io_poll_wake(struct wait_queue_entry *wait, unsigned mode, int sync,</div><div class='ctx'> 						 wait);</div><div class='ctx'> 	__poll_t mask = key_to_poll(key);</div><div class='ctx'> </div><div class='add'>+	if (unlikely(mask &amp; POLLFREE)) {</div><div class='add'>+		io_poll_mark_cancelled(req);</div><div class='add'>+		/* we have to kick tw in case it's not already */</div><div class='add'>+		io_poll_execute(req, 0);</div><div class='add'>+</div><div class='add'>+		/*</div><div class='add'>+		 * If the waitqueue is being freed early but someone is already</div><div class='add'>+		 * holds ownership over it, we have to tear down the request as</div><div class='add'>+		 * best we can. That means immediately removing the request from</div><div class='add'>+		 * its waitqueue and preventing all further accesses to the</div><div class='add'>+		 * waitqueue via the request.</div><div class='add'>+		 */</div><div class='add'>+		list_del_init(&amp;poll-&gt;wait.entry);</div><div class='add'>+</div><div class='add'>+		/*</div><div class='add'>+		 * Careful: this *must* be the last step, since as soon</div><div class='add'>+		 * as req-&gt;head is NULL'ed out, the request can be</div><div class='add'>+		 * completed and freed, since aio_poll_complete_work()</div><div class='add'>+		 * will no longer need to take the waitqueue lock.</div><div class='add'>+		 */</div><div class='add'>+		smp_store_release(&amp;poll-&gt;head, NULL);</div><div class='add'>+		return 1;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	/* for instances that support it check for an event match first */</div><div class='ctx'> 	if (mask &amp;&amp; !(mask &amp; poll-&gt;events))</div><div class='ctx'> 		return 0;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit </a> (<a href='https://git-scm.com/'>git 2.34.1</a>) at 2023-02-02 23:01:15 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
