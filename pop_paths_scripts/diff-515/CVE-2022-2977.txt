<!DOCTYPE html>
<html lang='en'>
<head>
<title>kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit '/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='http://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a title='kernel/git/torvalds/linux.git' href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='662893b4f6bd466ff9e1cd454c44c26d32d554fe'/><select name='h' onchange='this.form.submit();'>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=662893b4f6bd466ff9e1cd454c44c26d32d554fe'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=662893b4f6bd466ff9e1cd454c44c26d32d554fe'>tree</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=662893b4f6bd466ff9e1cd454c44c26d32d554fe'>commit</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=662893b4f6bd466ff9e1cd454c44c26d32d554fe'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/'>
<input type='hidden' name='id' value='662893b4f6bd466ff9e1cd454c44c26d32d554fe'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='662893b4f6bd466ff9e1cd454c44c26d32d554fe'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=662893b4f6bd466ff9e1cd454c44c26d32d554fe'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/char/tpm/tpm-chip.c?id=662893b4f6bd466ff9e1cd454c44c26d32d554fe'>drivers/char/tpm/tpm-chip.c</a></td><td class='right'>46</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 12.3%;'/><td class='rem' style='width: 58.5%;'/><td class='none' style='width: 29.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/char/tpm/tpm.h?id=662893b4f6bd466ff9e1cd454c44c26d32d554fe'>drivers/char/tpm/tpm.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 3.1%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/char/tpm/tpm2-space.c?id=662893b4f6bd466ff9e1cd454c44c26d32d554fe'>drivers/char/tpm/tpm2-space.c</a></td><td class='right'>65</td><td class='graph'><table summary='file diffstat' width='65%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 75 insertions, 38 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/char/tpm/tpm-chip.c b/drivers/char/tpm/tpm-chip.c<br/>index df37e7b6a10a5..65d800ecc9964 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/char/tpm/tpm-chip.c?id=5a0735b0bcf9eb8143136a660eb0e02b46d2007c'>drivers/char/tpm/tpm-chip.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/char/tpm/tpm-chip.c?id=662893b4f6bd466ff9e1cd454c44c26d32d554fe'>drivers/char/tpm/tpm-chip.c</a></div><div class='hunk'>@@ -274,14 +274,6 @@ static void tpm_dev_release(struct device *dev)</div><div class='ctx'> 	kfree(chip);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void tpm_devs_release(struct device *dev)</div><div class='del'>-{</div><div class='del'>-	struct tpm_chip *chip = container_of(dev, struct tpm_chip, devs);</div><div class='del'>-</div><div class='del'>-	/* release the master device reference */</div><div class='del'>-	put_device(&amp;chip-&gt;dev);</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> /**</div><div class='ctx'>  * tpm_class_shutdown() - prepare the TPM device for loss of power.</div><div class='ctx'>  * @dev: device to which the chip is associated.</div><div class='hunk'>@@ -344,7 +336,6 @@ struct tpm_chip *tpm_chip_alloc(struct device *pdev,</div><div class='ctx'> 	chip-&gt;dev_num = rc;</div><div class='ctx'> </div><div class='ctx'> 	device_initialize(&amp;chip-&gt;dev);</div><div class='del'>-	device_initialize(&amp;chip-&gt;devs);</div><div class='ctx'> </div><div class='ctx'> 	chip-&gt;dev.class = tpm_class;</div><div class='ctx'> 	chip-&gt;dev.class-&gt;shutdown_pre = tpm_class_shutdown;</div><div class='hunk'>@@ -352,39 +343,20 @@ struct tpm_chip *tpm_chip_alloc(struct device *pdev,</div><div class='ctx'> 	chip-&gt;dev.parent = pdev;</div><div class='ctx'> 	chip-&gt;dev.groups = chip-&gt;groups;</div><div class='ctx'> </div><div class='del'>-	chip-&gt;devs.parent = pdev;</div><div class='del'>-	chip-&gt;devs.class = tpmrm_class;</div><div class='del'>-	chip-&gt;devs.release = tpm_devs_release;</div><div class='del'>-	/* get extra reference on main device to hold on</div><div class='del'>-	 * behalf of devs.  This holds the chip structure</div><div class='del'>-	 * while cdevs is in use.  The corresponding put</div><div class='del'>-	 * is in the tpm_devs_release (TPM2 only)</div><div class='del'>-	 */</div><div class='del'>-	if (chip-&gt;flags &amp; TPM_CHIP_FLAG_TPM2)</div><div class='del'>-		get_device(&amp;chip-&gt;dev);</div><div class='del'>-</div><div class='ctx'> 	if (chip-&gt;dev_num == 0)</div><div class='ctx'> 		chip-&gt;dev.devt = MKDEV(MISC_MAJOR, TPM_MINOR);</div><div class='ctx'> 	else</div><div class='ctx'> 		chip-&gt;dev.devt = MKDEV(MAJOR(tpm_devt), chip-&gt;dev_num);</div><div class='ctx'> </div><div class='del'>-	chip-&gt;devs.devt =</div><div class='del'>-		MKDEV(MAJOR(tpm_devt), chip-&gt;dev_num + TPM_NUM_DEVICES);</div><div class='del'>-</div><div class='ctx'> 	rc = dev_set_name(&amp;chip-&gt;dev, "tpm%d", chip-&gt;dev_num);</div><div class='ctx'> 	if (rc)</div><div class='ctx'> 		goto out;</div><div class='del'>-	rc = dev_set_name(&amp;chip-&gt;devs, "tpmrm%d", chip-&gt;dev_num);</div><div class='del'>-	if (rc)</div><div class='del'>-		goto out;</div><div class='ctx'> </div><div class='ctx'> 	if (!pdev)</div><div class='ctx'> 		chip-&gt;flags |= TPM_CHIP_FLAG_VIRTUAL;</div><div class='ctx'> </div><div class='ctx'> 	cdev_init(&amp;chip-&gt;cdev, &amp;tpm_fops);</div><div class='del'>-	cdev_init(&amp;chip-&gt;cdevs, &amp;tpmrm_fops);</div><div class='ctx'> 	chip-&gt;cdev.owner = THIS_MODULE;</div><div class='del'>-	chip-&gt;cdevs.owner = THIS_MODULE;</div><div class='ctx'> </div><div class='ctx'> 	rc = tpm2_init_space(&amp;chip-&gt;work_space, TPM2_SPACE_BUFFER_SIZE);</div><div class='ctx'> 	if (rc) {</div><div class='hunk'>@@ -396,7 +368,6 @@ struct tpm_chip *tpm_chip_alloc(struct device *pdev,</div><div class='ctx'> 	return chip;</div><div class='ctx'> </div><div class='ctx'> out:</div><div class='del'>-	put_device(&amp;chip-&gt;devs);</div><div class='ctx'> 	put_device(&amp;chip-&gt;dev);</div><div class='ctx'> 	return ERR_PTR(rc);</div><div class='ctx'> }</div><div class='hunk'>@@ -445,14 +416,9 @@ static int tpm_add_char_device(struct tpm_chip *chip)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (chip-&gt;flags &amp; TPM_CHIP_FLAG_TPM2) {</div><div class='del'>-		rc = cdev_device_add(&amp;chip-&gt;cdevs, &amp;chip-&gt;devs);</div><div class='del'>-		if (rc) {</div><div class='del'>-			dev_err(&amp;chip-&gt;devs,</div><div class='del'>-				"unable to cdev_device_add() %s, major %d, minor %d, err=%d\n",</div><div class='del'>-				dev_name(&amp;chip-&gt;devs), MAJOR(chip-&gt;devs.devt),</div><div class='del'>-				MINOR(chip-&gt;devs.devt), rc);</div><div class='del'>-			return rc;</div><div class='del'>-		}</div><div class='add'>+		rc = tpm_devs_add(chip);</div><div class='add'>+		if (rc)</div><div class='add'>+			goto err_del_cdev;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	/* Make the chip available. */</div><div class='hunk'>@@ -460,6 +426,10 @@ static int tpm_add_char_device(struct tpm_chip *chip)</div><div class='ctx'> 	idr_replace(&amp;dev_nums_idr, chip, chip-&gt;dev_num);</div><div class='ctx'> 	mutex_unlock(&amp;idr_lock);</div><div class='ctx'> </div><div class='add'>+	return 0;</div><div class='add'>+</div><div class='add'>+err_del_cdev:</div><div class='add'>+	cdev_device_del(&amp;chip-&gt;cdev, &amp;chip-&gt;dev);</div><div class='ctx'> 	return rc;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -649,7 +619,7 @@ void tpm_chip_unregister(struct tpm_chip *chip)</div><div class='ctx'> 		hwrng_unregister(&amp;chip-&gt;hwrng);</div><div class='ctx'> 	tpm_bios_log_teardown(chip);</div><div class='ctx'> 	if (chip-&gt;flags &amp; TPM_CHIP_FLAG_TPM2)</div><div class='del'>-		cdev_device_del(&amp;chip-&gt;cdevs, &amp;chip-&gt;devs);</div><div class='add'>+		tpm_devs_remove(chip);</div><div class='ctx'> 	tpm_del_char_device(chip);</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(tpm_chip_unregister);</div><div class='head'>diff --git a/drivers/char/tpm/tpm.h b/drivers/char/tpm/tpm.h<br/>index 283f78211c3a7..2163c6ee0d364 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/char/tpm/tpm.h?id=5a0735b0bcf9eb8143136a660eb0e02b46d2007c'>drivers/char/tpm/tpm.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/char/tpm/tpm.h?id=662893b4f6bd466ff9e1cd454c44c26d32d554fe'>drivers/char/tpm/tpm.h</a></div><div class='hunk'>@@ -234,6 +234,8 @@ int tpm2_prepare_space(struct tpm_chip *chip, struct tpm_space *space, u8 *cmd,</div><div class='ctx'> 		       size_t cmdsiz);</div><div class='ctx'> int tpm2_commit_space(struct tpm_chip *chip, struct tpm_space *space, void *buf,</div><div class='ctx'> 		      size_t *bufsiz);</div><div class='add'>+int tpm_devs_add(struct tpm_chip *chip);</div><div class='add'>+void tpm_devs_remove(struct tpm_chip *chip);</div><div class='ctx'> </div><div class='ctx'> void tpm_bios_log_setup(struct tpm_chip *chip);</div><div class='ctx'> void tpm_bios_log_teardown(struct tpm_chip *chip);</div><div class='head'>diff --git a/drivers/char/tpm/tpm2-space.c b/drivers/char/tpm/tpm2-space.c<br/>index d2225020e4d2c..ffb35f0154c16 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=5a0735b0bcf9eb8143136a660eb0e02b46d2007c'>drivers/char/tpm/tpm2-space.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/char/tpm/tpm2-space.c?id=662893b4f6bd466ff9e1cd454c44c26d32d554fe'>drivers/char/tpm/tpm2-space.c</a></div><div class='hunk'>@@ -574,3 +574,68 @@ out:</div><div class='ctx'> 	dev_err(&amp;chip-&gt;dev, "%s: error %d\n", __func__, rc);</div><div class='ctx'> 	return rc;</div><div class='ctx'> }</div><div class='add'>+</div><div class='add'>+/*</div><div class='add'>+ * Put the reference to the main device.</div><div class='add'>+ */</div><div class='add'>+static void tpm_devs_release(struct device *dev)</div><div class='add'>+{</div><div class='add'>+	struct tpm_chip *chip = container_of(dev, struct tpm_chip, devs);</div><div class='add'>+</div><div class='add'>+	/* release the master device reference */</div><div class='add'>+	put_device(&amp;chip-&gt;dev);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/*</div><div class='add'>+ * Remove the device file for exposed TPM spaces and release the device</div><div class='add'>+ * reference. This may also release the reference to the master device.</div><div class='add'>+ */</div><div class='add'>+void tpm_devs_remove(struct tpm_chip *chip)</div><div class='add'>+{</div><div class='add'>+	cdev_device_del(&amp;chip-&gt;cdevs, &amp;chip-&gt;devs);</div><div class='add'>+	put_device(&amp;chip-&gt;devs);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/*</div><div class='add'>+ * Add a device file to expose TPM spaces. Also take a reference to the</div><div class='add'>+ * main device.</div><div class='add'>+ */</div><div class='add'>+int tpm_devs_add(struct tpm_chip *chip)</div><div class='add'>+{</div><div class='add'>+	int rc;</div><div class='add'>+</div><div class='add'>+	device_initialize(&amp;chip-&gt;devs);</div><div class='add'>+	chip-&gt;devs.parent = chip-&gt;dev.parent;</div><div class='add'>+	chip-&gt;devs.class = tpmrm_class;</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * Get extra reference on main device to hold on behalf of devs.</div><div class='add'>+	 * This holds the chip structure while cdevs is in use. The</div><div class='add'>+	 * corresponding put is in the tpm_devs_release.</div><div class='add'>+	 */</div><div class='add'>+	get_device(&amp;chip-&gt;dev);</div><div class='add'>+	chip-&gt;devs.release = tpm_devs_release;</div><div class='add'>+	chip-&gt;devs.devt = MKDEV(MAJOR(tpm_devt), chip-&gt;dev_num + TPM_NUM_DEVICES);</div><div class='add'>+	cdev_init(&amp;chip-&gt;cdevs, &amp;tpmrm_fops);</div><div class='add'>+	chip-&gt;cdevs.owner = THIS_MODULE;</div><div class='add'>+</div><div class='add'>+	rc = dev_set_name(&amp;chip-&gt;devs, "tpmrm%d", chip-&gt;dev_num);</div><div class='add'>+	if (rc)</div><div class='add'>+		goto err_put_devs;</div><div class='add'>+</div><div class='add'>+	rc = cdev_device_add(&amp;chip-&gt;cdevs, &amp;chip-&gt;devs);</div><div class='add'>+	if (rc) {</div><div class='add'>+		dev_err(&amp;chip-&gt;devs,</div><div class='add'>+			"unable to cdev_device_add() %s, major %d, minor %d, err=%d\n",</div><div class='add'>+			dev_name(&amp;chip-&gt;devs), MAJOR(chip-&gt;devs.devt),</div><div class='add'>+			MINOR(chip-&gt;devs.devt), rc);</div><div class='add'>+		goto err_put_devs;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='add'>+</div><div class='add'>+err_put_devs:</div><div class='add'>+	put_device(&amp;chip-&gt;devs);</div><div class='add'>+</div><div class='add'>+	return rc;</div><div class='add'>+}</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit </a> (<a href='https://git-scm.com/'>git 2.34.1</a>) at 2023-02-02 23:00:44 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>
